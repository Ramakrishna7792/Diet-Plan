<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calorie Tracker - Track</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="navbar.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            background-color: #f4f4f9;
            padding: 20px;
        }

.main-content {
    margin-top: 8%;
  display: flex;
  margin-left: 10px;
}
        
.dashboard-container {
  display: flex;
  position: absolute;
  margin-top: 5%;
  z-index: 1;
}

.sidebar {
  width: 60px;
  background-color: #8FDC8F;
  box-shadow: rgba(0, 0, 0, 0.19) 0px 10px 20px, rgba(0, 0, 0, 0.23) 0px 6px 6px;
  display: grid;
  align-items: center;
  justify-content: center;
  height: 400px;
  border-top-right-radius: 30px;
  border-bottom-right-radius: 30px;
  margin-top: 100px;
}

.dashboard-text {
  writing-mode: vertical-rl;
  transform: rotate(270deg);
  font-family: 'Poppins', sans-serif;
  font-weight: bold;
  color: black;
  font-size: 18px;
  letter-spacing: 3px;
  /* padding-right: 15px; */
  display: flex;
}

.info-box {
  width: 280px;
  height: 500px;
  /* position: absolute; */
  /* background-color: black; */
  border-radius: 10px;
  background-color: rgb(215, 209, 242);
  box-shadow: rgba(0, 0, 0, 0.19) 0px 10px 20px, rgba(0, 0, 0, 0.23) 0px 6px 6px;
  margin-left: 70px;
  
}

.date-box {
  width: 520px;
  height: 70px;
  padding-left: 10px;
  position: absolute;
  background-color: white;
  box-shadow: rgba(0, 0, 0, 0.19) 0px 10px 20px, rgba(0, 0, 0, 0.23) 0px 6px 6px;
  border-radius: 20px;
  margin-left: 350px;
  margin-top: 3px;
  display: flex;
  background-color: lightgreen;
  /* position: static; */
}

.date-box p{
  color: black;
  font-size: 20px;
  font-weight: 800;
  
}

input[type="date"]{
  background-color: #0080ff;
  padding: 15px;
  position: absolute;
  transform: translate(-50%,-50%);
  top: 50%;
  left: 73%;
  font-family: "Roboto Mono",monospace;
  color: #ffffff;
  font-size: 18px;
  border: none;
  outline: none;
  border-radius: 10px;
  height: 15px;
}
::-webkit-calendar-picker-indicator{
  background-color: #ffffff;
  padding: 5px;
  cursor: pointer;
  border-radius: 3px;
}

.data-box{
  width: 920px;
  height: 900px;
  border-radius: 10px;
  background-color: white;
  box-shadow: rgba(0, 0, 0, 0.19) 0px 10px 20px, rgba(0, 0, 0, 0.23) 0px 6px 6px;
  margin-left: 45px;
  display: flex;
}

.left-data-box{
  width: 320px;
  height: 520px;
  border-radius: 10px;
  background-color: white;
  /* box-shadow: rgba(0, 0, 0, 0.19) 0px 10px 20px, rgba(0, 0, 0, 0.23) 0px 6px 6px; */
  margin-left: 5px;
  margin-top:10px;
  z-index: 3;
  gap: 10px;
  display: grid;
}




.charts {
    /* display: flex; */
    /* justify-content: space-around; */
    margin-top: 0px;
    z-index: 5;
    width: 250px;
    height: 250px;
    gap: 120px;
    padding-left: 20px;
    padding-top: 20px;
}

.charts1{
    margin-top: 0px;
    z-index: 5;
    width: 250px;
    height: 250px;
    gap: 10px;
    padding-left: 20px;
    padding-top: 10px;

}

.charts2{
    margin-top: 0px;
    z-index: 5;
    width: 530px;
    height: 210px;
    /* gap: 10px; */
    padding-left: 20px;
    padding-top: 10px;
    box-shadow: rgba(0, 0, 0, 0.19) 0px 10px 20px, rgba(0, 0, 0, 0.23) 0px 6px 6px;
    border-radius: 10px;
}

.chart3{
    margin-top: 10px;
    z-index: 6;
    width: 530px;
    height: 200px;
    gap: 10px;
    padding-left: 20px;
    padding-top: 10px;
    box-shadow: rgba(0, 0, 0, 0.19) 0px 10px 20px, rgba(0, 0, 0, 0.23) 0px 6px 6px;
    border-radius: 10px;
}

.chart4{
    margin-top: 42%;
    position: absolute;
    z-index: 6;
    width: 560px;
    height: 300px;
    gap: 10px;
    /* padding-left: 20px; */
    padding-top: 10px;
    box-shadow: rgba(0, 0, 0, 0.19) 0px 10px 20px, rgba(0, 0, 0, 0.23) 0px 6px 6px;
    border-radius: 10px;
    margin-left: 15%;

}

.chart4 canvas{
    display: block;
    margin-top: 25px;
    padding-left: 25px ;
}

#weeklyChart{
    width: 100%;
    height: 100%;
    display: block;
}

#monthlyChart{
    width: 100%;
    height: 100%;
    /* display: block; */
    position: relative;
}


.space{
    width: 320px;
    height: 20px;
}

h4{
    position: absolute;
    margin-top: 0;
    padding-left: 40px;
    padding-bottom: 100px;
}

.right-data {
  width: 530px;
  height: 400px;
  background-color: white;
  /* box-shadow: rgba(0, 0, 0, 0.19) 0px 10px 20px, rgba(0, 0, 0, 0.23) 0px 6px 6px; */
  border-radius: 20px;
  position: absolute;
  margin-left: 350px;
  margin-top: 95px;
  /* gap: 20px; */
}

#donutChart{
    border-radius: 50%;
}
canvas {
    max-width: 500px;
}

label {
    margin-top: 5px;
}

select {
    padding: 2px;

}
#backButton {
    margin-top: 20px;
    padding: 10px 20px;
    background-color: #36A2EB;
    color: white;
    border: none;
    cursor: pointer;
    font-size: 16px;
    border-radius: 5px;
}
        #backButton:hover {
            background-color: #2980b9;
        }

        #userData{
            font-size: 16px;
            justify-content: left;
            text-align: left;
            padding-left: 20px;
        }

        h2{
            text-decoration: underline;
            text-align: center;
            padding-left: 0;
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <div class="sidebar">
            <span class="dashboard-text">D</span>
            <span class="dashboard-text">A</span>
            <span class="dashboard-text">S</span>
            <span class="dashboard-text">H</span>
            <span class="dashboard-text">B</span>
            <span class="dashboard-text">O</span>
            <span class="dashboard-text">A</span>
            <span class="dashboard-text">R</span>
            <span class="dashboard-text">D</span>
        </div>
    </div>
    <div class="main-content">
        <div class="info-box" id="userData"></div>
        <div class="data-box">
            <div class="date-box">
                <label for="trackDate"><p>Calorie consumption on:<p></label>
                <input type="date" id="trackDate">
            </div>
            <div class="left-data-box">
                <div class="charts">
                    <h4>Daily Calories</h4>
                    <div class="space"></div>
                    <canvas id="donutChart"></canvas>
                </div>
                <div class="space"></div>
                <div class="charts1">
                    <h4>Meal distribution</h4>
                    <div class="space"></div>
                    <canvas id="mealChart"></canvas>
                </div>
            </div>
            <div class="right-data">
                <div class="charts2">
                  
                    <h4>Weekly Calories</h4>
                    <canvas id="weeklyChart"></canvas>
                </div>
                <div class="chart3">
                    <h4>Monthly Chart</h4>
                    <canvas id="monthlyChart"></canvas>
                </div>
            </div>
            <div class="chart4">
                <h4 style="padding-left: 40px;">Expected Weight Chart</h4>
                <canvas id="weightProgressionChart" width="400" height="200"></canvas>

            </div>
        </div>
    </div>
    </div>

    <!-- Back Button -->
    <button id="backButton" onclick="goBackToDiet()">Back to Diet</button>

    <script>

    document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const email = urlParams.get('email');

            console.log(email)

            if (email) {
                fetch(`http://localhost:3000/get-user?email=${email}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success && data.data) {
                            const user = data.data;

                            // Update the target calories globally
                            userTargetCalories = user.targetCalories;


                            const userDataDiv = document.getElementById('userData');
                            userDataDiv.innerHTML = `
                                <h2>User Details</h2>
                                <p><strong>Name:</strong> ${user.name}</p>
                                <p><strong>Email:</strong> ${user.email}</p>
                                <p><strong>Age:</strong> ${user.age}</p>
                                <p><strong>Height:</strong> ${user.height} cm</p>
                                <p><strong>Current Weight:</strong> ${user.currentWeight} kg</p>
                                <p><strong>Goal Weight:</strong> ${user.goalWeight} kg</p>
                                <p><strong>Gender:</strong> ${user.gender}</p>
                                <p><strong>Goal Type:</strong> ${user.goalType}</p>
                                <p><strong>Duration:</strong> ${user.duration} months</p>
                                <p><strong>Target Calories:</strong> ${user.targetCalories} kcal/day</p>
                            `;
                        } else {
                            alert('User data not found.');
                            // window.location.href="index2.html";
                        }
                    })
                    .catch(error => console.error('Error fetching data:', error));
            } else {
                // alert('No email provided.');
                window.location.href="index5.html"
            }
        });

        const trackDate = document.getElementById('trackDate');
        let donutChartInstance = null;
        let mealChartInstance = null;
        let weeklyChartInstance = null;
        let monthlyChartInstance = null;
    
        // Event listener when date is selected
        trackDate.addEventListener('change', () => {
            const date = trackDate.value;
            fetchDataForTrack(date, userTargetCalories);  // Fetch data when the date changes
        });
    
        function fetchDataForTrack(date, targetCalories) {
            // Make sure the date is selected before calling the API
            if (!date) {
                alert('Please select a date.');
                return;
            }
    
            // Fetch data from the backend based on the selected date
            fetch(`http://127.0.0.1:3000/get-data?date=${date}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Clear existing charts before rendering new ones
                        if (donutChartInstance) donutChartInstance.destroy();
                        if (mealChartInstance) mealChartInstance.destroy();
                        if (weeklyChartInstance) weeklyChartInstance.destroy();
                        if (monthlyChartInstance) monthlyChartInstance.destroy();
    
                        // Create new charts with the fetched data
                        createDonutChart(data,targetCalories);
                        createMealChart(data);
                        createWeeklyChart(date);  // Pass the selected date to get weekly data
                        createMonthlyChart(date);
                    } else {
                        alert(data.message || 'Error fetching data');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Failed to fetch data.');
                });
        }
    
        // Create Donut Chart for Daily Calories
        function createDonutChart(data, targetCalories) {
            // const targercalory = null;
            // fetch(`http://localhost:3000/get-user?email=${email}`)
            //         .then(response => response.json())
            //         .then(data => {
            //             if (data.success && data.data) {
            //                 const user = data.data;
                            
                                
            //                     targercalory = user.targetCalories;
                            
            //             } else {
            //                 alert('User data not found.');
            //             }
            //         })
            //         .catch(error => console.error('Error fetching data:', error));
            

            const ctx = document.getElementById('donutChart').getContext('2d');
            const remainingCalories = targetCalories - data.totalCalories;

            donutChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Calories Consumed', 'Remaining Calories'],
                    datasets: [{
                        data: [data.totalCalories, remainingCalories > 0 ? remainingCalories : 0],
                        backgroundColor: ['#36A2EB', '#FF5733']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            labels: {
                                font: {
                                    size: 8 // Adjust the size of the legend labels (default: 12)
                                }
                            }
                        }
                    },
                    cutout: '70%'
                }   
            });
        }
    
        // Create Bar Chart for Meal Calories (Breakfast, Lunch, Dinner)
        function createMealChart(data) {
            const ctx = document.getElementById('mealChart').getContext('2d');
            mealChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Breakfast', 'Lunch', 'Dinner'],
                    datasets: [{
                        label: 'Calories',
                        data: [data.breakfastCalories, data.lunchCalories, data.dinnerCalories],
                        backgroundColor: ['#FF6384', '#36A2EB', '#FFCD56']
                    }]
                },
                options: {
                    responsive: true
                }
            });
        }
    
        // Create Weekly Calories Line Chart
        function createWeeklyChart(selectedDate) {
            // Get next 6 days (including the selected date)
            const dates = [];
            const calorieData = [];
    
            for (let i = 0; i < 7; i++) {
                const newDate = new Date(selectedDate);
                newDate.setDate(newDate.getDate() + i);
                dates.push(newDate.toISOString().split('T')[0]);  // Format as YYYY-MM-DD
            }
    
            // Fetch calorie data for each of the next 7 days
            Promise.all(dates.map(date => fetch(`http://127.0.0.1:3000/get-data?date=${date}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        calorieData.push(data.totalCalories);
                    } else {
                        calorieData.push(0);  // Default value if data is not available
                    }
                })
            ))
            .then(() => {
                const ctx = document.getElementById('weeklyChart').getContext('2d');
                weeklyChartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: dates,
                        datasets: [{
                            label: 'Weekly Calories',
                            data: calorieData,
                            borderColor: '#FF5733',
                            backgroundColor: 'rgba(255, 87, 51, 0.2)',
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false
                    }
                });
            })
            .catch(error => console.error(error));
        }

       // Create Monthly Chart for the Yearly View
function createMonthlyChart(selectedDate) {
    // Extract the year from the selected date
    const year = new Date(selectedDate).getFullYear();
    const months = [
        'January', 'February', 'March', 'April', 'May', 'June',
        'July', 'August', 'September', 'October', 'November', 'December'
    ];

    // Initialize calorie data array with zeros for all months
    const calorieData = Array(12).fill(0);

    // Fetch calorie data for each month of the selected year
    Promise.all(months.map((_, monthIndex) => {
        const startDate = `${year}-${String(monthIndex + 1).padStart(2, '0')}-01`;
        const endDate = new Date(year, monthIndex + 1, 0).toISOString().split('T')[0]; // Last day of the month

        return fetch(`http://127.0.0.1:3000/get-monthly-data?start_date=${startDate}&end_date=${endDate}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`API request failed with status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    calorieData[monthIndex] = data.totalCalories || 0; // Add total calories or default to 0
                }
            })
            .catch(error => {
                console.error(`Error fetching data for ${months[monthIndex]}:`, error);
            });
    }))
    .then(() => {
        // Create or update the chart
        const ctx = document.getElementById('monthlyChart').getContext('2d');
        if (window.monthlyChartInstance) {
            window.monthlyChartInstance.destroy(); // Clear existing chart if it exists
        }
        window.monthlyChartInstance = new Chart(ctx, {
            type: 'bar', // Bar chart for monthly data
            data: {
                labels: months, // Months of the year
                datasets: [{
                    label: `Monthly Calories (${year})`,
                    data: calorieData,
                    backgroundColor: '#36A2EB',
                    borderColor: '#FF5733',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        labels: {
                            font: {
                                size: 10 // Adjust font size
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    })
    .catch(error => console.error('Error fetching or rendering chart data:', error));
}

    
        // Function to navigate back to the Diet Page
        function goBackToDiet() {
            const urlParams = new URLSearchParams(window.location.search);

         // Extract the email parameter
        const email = urlParams.get('email');

        // Redirect to registration.html with email as a query parameter
        window.location.href = `index2.html?email=${encodeURIComponent(email)}`;
        }


        //new chart things
        document.addEventListener('DOMContentLoaded', () => {
    const urlParams = new URLSearchParams(window.location.search);
    const email = urlParams.get('email');

    if (email) {
        fetch(`http://localhost:3000/get-user?email=${email}`)
            .then(response => response.json())
            .then(data => {
                if (data.success && data.data) {
                    const user = data.data;

                    // Extract user's plan data
                    const currentWeight = user.currentWeight;
                    const goalWeight = user.goalWeight;
                    const durationMonths = user.duration; // Number of months user entered
                    
                    // Call the function to calculate and render the weight progression chart
                    renderWeightProgressionChart(currentWeight, goalWeight, durationMonths);
                } else {
                    alert('data not found to plot the charts.');
                }
            })
            .catch(error => console.error('Error fetching user data:', error));
    } else {
        alert('No email provided.');
        window.location.href = "index5.html";
    }
});

/**
 * Function to calculate and render the weight progression chart
 */
 function renderWeightProgressionChart(currentWeight, goalWeight, durationMonths) {
    // Generate month labels dynamically based on duration, starting from Month 0
    const months = Array.from({ length: durationMonths + 1 }, (_, i) => `Month ${i}`);

    // Calculate the monthly weight change
    const totalWeightChange = goalWeight - currentWeight;
    const monthlyWeightChange = totalWeightChange / durationMonths;

    // Calculate weight progression for each month, including Month 0 (initial weight)
    const weightProgression = Array.from({ length: durationMonths + 1 }, (_, i) => 
        currentWeight + monthlyWeightChange * i // Start at Month 0
    );

    // Render the chart
    const ctx = document.getElementById('weightProgressionChart').getContext('2d');
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: months, // Use dynamically generated month labels
            datasets: [{
                label: 'Expected Weight Progression (kg)',
                data: weightProgression,
                borderColor: '#36A2EB',
                backgroundColor: 'rgba(54, 162, 235, 0.2)',
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: false,
                    title: {
                        display: true,
                        text: 'Weight (kg)'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Months'
                    }
                }
            },
            plugins: {
                legend: {
                    display: true
                }
            }
        }
    });
}


    </script>
    
</body>
</html>
